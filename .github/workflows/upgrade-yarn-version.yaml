name: Upgrade Yarn version
permissions:
  contents: write
  id-token: write
  pull-requests: write
on:
  schedule:
    - cron: "0 10 * * 1-5"
  workflow_dispatch:
jobs:
  upgrade-yarn-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x
          cache: "npm"
      - name: yarn set version stable
        run: |
          echo "OLD_YARN_VERSION=$(cat package.json | jq -r .packageManager)" >> ${{ github.env }}
          export YARN_ENABLE_IMMUTABLE_INSTALLS=false
          yarn set version stable
          yarn install
          echo "NEW_YARN_VERSION=$(cat package.json | jq -r .packageManager)" >> ${{ github.env }}
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: Upgrade Yarn version from ${{ env.OLD_YARN_VERSION }} to ${{ env.NEW_YARN_VERSION }}
          title: Upgrade Yarn version from ${{ env.OLD_YARN_VERSION }} to ${{ env.NEW_YARN_VERSION }}
          body: |
            Upgrade Yarn version from ${{ env.OLD_YARN_VERSION }} to ${{ env.NEW_YARN_VERSION }}:
            https://github.com/yarnpkg/berry/releases/tag/%40yarnpkg/cli/${{ env.NEW_YARN_VERSION }}

            - [ ] Set PR as "Ready for review"
            - [ ] Check CI
            - [ ] Submit PR review
          branch: upgrade-yarn
          delete-branch: true
          draft: always-true # Because of: https://github.com/peter-evans/create-pull-request/blob/main/docs/concepts-guidelines.md#triggering-further-workflow-runs.
